<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SEOBoss — Connect Your Store</title>

  <!-- Shopify App Bridge UMD (works in plain HTML) -->
  <script src="https://unpkg.com/@shopify/app-bridge@3.7.10/umd/index.js"></script>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge-utils/index.umd.min.js"></script>
  <style>
    html,body{margin:0;padding:0;background:#0A0F0D;color:#fff;font-family:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif}
    #wrap{max-width:980px;margin:0 auto;padding:1.2rem}
    .panel{margin:1.4rem auto;padding:1.4rem;border-radius:18px;background:linear-gradient(135deg,#0f0c29,#302b63 60%,#0f0c29);box-shadow:0 0 36px rgba(0,245,212,.22)}
    .row{display:flex;flex-direction:column;gap:.6rem;background:rgba(255,255,255,.06);padding:1rem;border:1px solid rgba(255,255,255,.09);border-radius:12px;margin:.8rem 0}
    .row.two{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    label{font-weight:800;color:#eafff7}
    small{color:#a0ffd7}
    input,select,textarea{width:100%;padding:.9rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#fff;box-sizing:border-box}
    .actions{display:flex;gap:.6rem;margin-top:.4rem}
    .btn{padding:.9rem 1.1rem;border-radius:12px;font-weight:900;cursor:pointer;border:1px solid rgba(255,255,255,.14);color:#eafff7;background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg,#00f5d4,#00bbf9);color:#062621;border:none;box-shadow:0 0 16px rgba(0,255,200,.35)}
    .card{margin:1rem 0;padding:1rem;border-radius:12px;background:rgba(255,255,255,.08);color:#e9fbff}
  </style>

  <script>
  (function () {
    const qs   = new URLSearchParams(location.search);
    const host = qs.get('host') || '';
    const shop = (qs.get('shop') || '').toLowerCase();

    // 1) If not embedded but Shopify gave us a host param → reframe into Admin
    if (host && window.top === window.self) {
      try {
        const app = window.createApp({ apiKey: 'YOUR_PUBLIC_API_KEY', host }); // ← put your Client ID here
        const { Redirect } = window.actions;
        Redirect.create(app).dispatch(Redirect.Action.REMOTE, location.href);
      } catch (e) {
        console.warn('[SEOBoss] App Bridge reframe failed', e);
      }
    }

    // 2) If embedded, expose a token-auth fetch for your Admin endpoints
    try {
      if (host && window.top !== window.self) {
        const app = window.createApp({ apiKey: '5654f5c575452aefdca2592d2a2d1f3d', host }); // ← same Client ID
        window.SEO_BOSS_FETCH = async (url, payload) => {
          const token = await window.getSessionToken(app);
          return fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json','Accept':'application/json' },
            body: JSON.stringify(payload || {})
          });
        };
        window.__SEOBOSS_EMBEDDED__ = true;
      }
    } catch (e) {
      console.warn('[SEOBoss] token fetch init failed', e);
    }

    // Expose shop for convenience
    if (shop) window.__SEOBOSS_SHOP__ = shop;
  })();
  </script>
</head>
<body>
  <div id="wrap">
    <div class="panel">
      <h2>👑 SEOBoss — Connect Your Store</h2>
      <p class="sub">We’ll discover your blogs and set up your workspace. No admin token required.</p>

      <form id="bossForm" novalidate>
        <input id="clientIdHidden" type="hidden" value="">

        <div class="row">
          <label>Shopify Store (domain only)</label>
          <input id="shopInput" placeholder="yourstore.myshopify.com" required>
          <small>No https:// — just the myshopify.com domain.</small>
        </div>

        <div class="row two">
          <div>
            <label>Language</label>
            <input id="defaultLanguage" placeholder="en" value="en" required>
          </div>
          <div>
            <label>Contact Email</label>
            <input id="contactEmail" type="email" placeholder="owner@example.com" required>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Tone</label>
            <input id="toneInput" placeholder="Helpful, expert, no hype">
          </div>
          <div>
            <label>Niche</label>
            <input id="nicheInput" placeholder="(e.g.) vocal health; natural energy drinks">
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Seed keywords (comma-separated)</label>
            <textarea id="seedKeywords" rows="3" placeholder="natural energy drink, manuka honey beverage, hydration energy"></textarea>
          </div>
          <div>
            <label>Target audience</label>
            <textarea id="targetAudience" rows="3" placeholder="Adults 45+; singers; wellness shoppers"></textarea>
          </div>
        </div>

        <div id="blogRow" class="row" style="display:none">
          <div>
            <label>Default blog</label>
            <select id="blogSelect"></select>
          </div>
        </div>

        <div class="actions">
          <button id="onboardBtn" type="submit" class="btn primary">🔌 Connect</button>
        </div>

        <div id="result" class="card" style="display:none" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
  (function () {
    const qs = new URLSearchParams(location.search);
    const embedded = !!qs.get('host');
    const shopFromUrl = (qs.get('shop') || '').toLowerCase();

    const el = {
      shopInput: document.getElementById('shopInput'),
      defaultLanguage: document.getElementById('defaultLanguage'),
      contactEmail: document.getElementById('contactEmail'),
      tone: document.getElementById('toneInput'),
      niche: document.getElementById('nicheInput'),
      seedKeywords: document.getElementById('seedKeywords'),
      targetAudience: document.getElementById('targetAudience'),
      blogRow: document.getElementById('blogRow'),
      blogSelect: document.getElementById('blogSelect'),
      onboardBtn: document.getElementById('onboardBtn'),
      result: document.getElementById('result')
    };

    // ---- HMAC helpers (public key is fine to expose) ----
function canonicalForm(obj) {
  const entries = Object.entries(obj || {})
    .filter(([_, v]) => v !== undefined && v !== null && String(v).trim() !== '')
    .map(([k, v]) => [String(k), String(v)]);
  entries.sort((a, b) => a[0].localeCompare(b[0]));
  return entries.map(([k, v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v)).join('&');
}

async function hmacHex(secret, message) {
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey('raw', enc.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
  return [...new Uint8Array(sig)].map(b => b.toString(16).padStart(2, '0')).join('');
}
    
    // Prefill/lock shop when embedded
    if (embedded && shopFromUrl) { el.shopInput.value = shopFromUrl; el.shopInput.disabled = true; }

    // Set these to your existing Netlify env values (the PUBLIC one is safe in browser)
const PUBLIC_HMAC_KEY = 'SEOBOSSSECRET_2025'; // e.g. SEOBOSSSECRET_2025
const FORWARD_SECRET  = '5654f5c575452aefdca2592d2a2d1f3d';  // this is already used by your relay

async function adminPost(url, params = {}) {
  // If App Bridge Utils loaded OK → use session token JSON POST
  if (typeof window.SEO_BOSS_FETCH === 'function') {
    return window.SEO_BOSS_FETCH(url, params);
  }

  // Fallback: sign x-www-form-urlencoded with your public HMAC
  const body = canonicalForm(params);
  const ts   = Math.floor(Date.now() / 1000).toString();
  const mac  = await hmacHex(PUBLIC_HMAC_KEY, body + '\n' + ts);

  return fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json',
      'X-SEOBOSS-FORWARD-SECRET': FORWARD_SECRET,
      'X-Seoboss-Ts': ts,
      'X-Seoboss-Hmac': mac,
      'X-Seoboss-Key-Id': 'global'
    },
    body
  });
}

      }
      // fallback if opened directly
      const body = new URLSearchParams(Object.entries(params).filter(([_,v]) => v!=null)).toString();
      return fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json' }, body });
    }
    const readJSON = async (r)=>{ const t = await r.text(); try{ return t?JSON.parse(t):{} }catch{ return { raw:t } } };

    // Your endpoints (you already have these behind the relay)
    const ENDPOINTS = {
      submit:  'https://hooks.seoboss.com/seoboss/api/onboarding/submit',
      update:  'https://hooks.seoboss.com/seoboss/api/client/profile',
      blogs:   'https://hooks.seoboss.com/.netlify/functions/list-blogs'
    };


    
    // Form submit
    document.getElementById('bossForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const payload = {
        client_name: '',
        contact_email: (el.contactEmail.value||'').trim(),
        default_language: (el.defaultLanguage.value||'en').trim().toLowerCase(),
        shop_input: (el.shopInput.value||'').trim().toLowerCase(),
        tone: (el.tone.value||'').trim(),
        niche: (el.niche.value||'').trim(),
        seed_keywords: (el.seedKeywords.value||'').trim(),
        target_audience: (el.targetAudience.value||'').trim()
      };

      if (!payload.shop_input || !payload.contact_email) {
        el.result.style.display='block'; el.result.innerHTML = '<span style="color:#ff9b9b">Please complete required fields.</span>';
        return;
      }

      el.onboardBtn.disabled = true;
      el.result.style.display='block';
      el.result.textContent = embedded ? 'Saving your preferences…' : 'Setting up your engine…';

      try {
        const url = embedded ? ENDPOINTS.update : ENDPOINTS.submit;
        const r = await adminPost(url, payload);
        const d = await readJSON(r);
        if (!r.ok || d.ok === false) throw new Error(d?.message || d?.raw || ('HTTP '+r.status));

        // If blogs list returned, show picker
        if (Array.isArray(d.blogs_list) && d.blogs_list.length) {
          const sel = el.blogSelect; sel.innerHTML = '';
          d.blogs_list.forEach(b=>{
            const opt = document.createElement('option');
            opt.value = String(b.id);
            opt.textContent = b.title || b.handle || ('Blog ' + b.id);
            sel.appendChild(opt);
          });
          if (d.default_blog_id) el.blogSelect.value = String(d.default_blog_id);
          el.blogRow.style.display = '';
        }

        el.result.innerHTML = '<strong>Done.</strong>';

      } catch (err) {
        el.result.innerHTML = `<span style="color:#ff9b9b">❌ ${err.message || 'Failed'}</span>`;
      } finally {
        el.onboardBtn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>
