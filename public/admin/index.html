<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SEOBoss — Connect Your Store</title>

  <!-- Shopify App Bridge v3 -->
  <script src="https://unpkg.com/@shopify/app-bridge@3.7.10/umd/index.js"></script>
  <script src="https://unpkg.com/@shopify/app-bridge-utils@3.7.10/umd/index.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #0A0F0D;
      color: #fff;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }
    
    /* SEOBoss Custom Styles */
    #seoboss-onboarding {
      --mint: #00f5d4;
      --blue: #00bbf9;
      --ink: #e0ffe9;
      --bgA: #0f0c29;
      --bgB: #302b63;
      --bgC: #24243e;
      background: linear-gradient(270deg, var(--bgA), var(--bgB), var(--bgC));
      background-size: 600% 600%;
      animation: soGrad 20s ease infinite;
      min-height: 100vh;
      padding: 1rem 0;
    }
    
    @keyframes soGrad {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 1.2rem;
    }
    
    .panel {
      margin: 1.4rem auto;
      padding: 1.4rem;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--bgA), var(--bgB) 60%, var(--bgA));
      box-shadow: 0 0 36px rgba(0, 245, 212, 0.22);
    }
    
    .head h2 {
      margin: 0.2rem 0 0.3rem;
      color: var(--mint);
      text-shadow: 0 0 10px rgba(0, 255, 200, 0.6);
    }
    
    .head .sub {
      color: #cfefff;
    }
    
    .status {
      font-weight: 700;
      margin-bottom: 0.4rem;
    }
    
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--mint);
      display: inline-block;
      margin-right: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 200, 0.8);
      animation: pulse 1.8s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(0.9); }
      50% { transform: scale(1.1); }
    }
    
    label {
      font-weight: 800;
      color: #eafff7;
      display: block;
      margin-bottom: 0.4rem;
    }
    
    small {
      color: #a0ffd7;
      display: block;
      margin-top: 0.3rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 1rem;
    }
    
    input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.04);
    }
    
    textarea {
      min-height: 50px;
      resize: vertical;
    }
    
    .row {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      background: rgba(255, 255, 255, 0.06);
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: 12px;
      margin: 0.8rem 0;
    }
    
    .row.two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.4rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 0.9rem 1.1rem;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.14);
      color: #eafff7;
      background: rgba(255, 255, 255, 0.06);
      text-decoration: none;
      display: inline-block;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: rgba(255, 255, 255, 0.12);
    }
    
    .btn.primary {
      background: linear-gradient(90deg, var(--mint), var(--blue));
      color: #062621;
      border: none;
      box-shadow: 0 0 16px rgba(0, 255, 200, 0.35);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.outline {
      background: transparent;
      border: 2px solid var(--mint);
    }
    
    .card {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      color: #e9fbff;
      box-shadow: 0 0 20px rgba(0, 255, 200, 0.24);
    }
    
    .saved {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.6rem;
      color: #b9ffe9;
    }
    
    code {
      background: rgba(255, 255, 255, 0.08);
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-family: 'Courier New', monospace;
    }
    
    .msg {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    @media (max-width: 820px) {
      .row.two {
        grid-template-columns: 1fr;
      }
      .wrap {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

<div id="seoboss-onboarding">
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div class="status"><span class="dot"></span> <span id="statusText">Initializing...</span></div>
        <small id="clientIdBadge" style="display:none;color:#a0ffd7">
          Client: <code id="clientIdDisplay">—</code>
        </small>
        <h2>👑 SEOBoss — Complete Your Setup</h2>
        <p class="sub">Tell us about your content so we can generate relevant, on-brand blog topics.</p>
      </div>

      <div id="onboardWrap">
        <form id="bossForm" novalidate>
          <!-- Hidden fields for activation -->
          <input id="clientIdHidden" type="hidden" value="">
          <input id="activationTokenHidden" type="hidden" value="">

          <!-- Shop (visible but disabled) -->
          <div class="row">
            <div>
              <label>Shopify Store</label>
              <input id="shopInput" placeholder="yourstore.myshopify.com" disabled>
              <small>Your store domain (provided by OAuth).</small>
            </div>
          </div>

          <!-- Contact & Language -->
          <div class="row two">
            <div>
              <label>Contact Email</label>
              <input id="contactEmail" type="email" placeholder="owner@example.com" required>
            </div>
            <div>
              <label>Language</label>
              <input id="defaultLanguage" placeholder="en" value="en" required>
            </div>
          </div>

          <!-- Tone & Niche -->
          <div class="row two">
            <div>
              <label>Tone</label>
              <input id="tone" placeholder="Helpful, expert, no hype">
              <small>Your brand voice.</small>
            </div>
            <div>
              <label>Niche</label>
              <input id="niche" placeholder="e.g. vocal health, natural energy drinks">
              <small>Your business focus.</small>
            </div>
          </div>

          <!-- Keywords & Audience -->
          <div class="row two">
            <div>
              <label>Seed keywords (comma-separated)</label>
              <textarea id="seedKeywords" rows="3" placeholder="natural energy drink, manuka honey beverage, hydration energy"></textarea>
            </div>
            <div>
              <label>Target audience</label>
              <textarea id="targetAudience" rows="3" placeholder="Adults 45+; singers; wellness shoppers"></textarea>
            </div>
          </div>

          <!-- Blog selector (populated by backend) -->
          <div id="blogRow" class="row" style="display:none">
            <div>
              <label>Default blog</label>
              <select id="blogSelect"></select>
            </div>
          </div>

          <div class="actions">
            <button id="activateBtn" type="submit" class="btn primary big">✨ Activate SEOBoss</button>
          </div>

          <div id="result" class="card" style="display:none" aria-live="polite"></div>
        </form>

        <!-- Success badge -->
        <div id="savedBadge" class="saved" style="display:none">
          <span>✅ Setup complete!</span>
          <code id="savedSummary"></code>
        </div>

        <!-- Workspace card -->
        <div id="engineCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">🚀 Your Content Engine is Ready</div>
          <p style="margin:.2rem 0 .8rem">
            Open your workspace to generate briefs, outlines, and internal links from your seed keywords.
          </p>
          <div class="actions">
            <a id="openSheetBtn" href="#" target="_blank" rel="noopener" class="btn primary">🔗 Open your workspace</a>
          </div>
        </div>

        <!-- Import existing posts -->
        <div id="interlinkingCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">📚 Import Existing Posts</div>
          <p style="margin:.2rem 0 .8rem">
            Fetch your current blog posts for interlinking and topic clustering.
          </p>
          <div class="actions">
            <button id="importArticlesBtn" class="btn outline">Fetch existing posts</button>
          </div>
          <small id="importMsg" class="msg"></small>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ============================================
  // 1. APP BRIDGE SETUP & AUTH CHECK
  // ============================================
  const urlParams = new URLSearchParams(window.location.search);
  const shop = urlParams.get('shop') || '';
  const host = urlParams.get('host') || '';
  const clientIdFromUrl = urlParams.get('client_id') || '';
  const activationTokenFromUrl = urlParams.get('activation_token') || '';
  
  console.log('[SEOBoss] Page loaded with params:', { shop, host, clientIdFromUrl, activationTokenFromUrl });

  if (!shop) {
    document.getElementById('statusText').textContent = 'Error: Missing shop parameter';
    console.error('[SEOBoss] No shop parameter in URL!');
    return;
  }

  const API_KEY = '5654f5c575452aefdca2592d2a2d1f3d'; // Your Shopify API key
  
  let app, appReady = false;
  
  try {
    // Check if App Bridge loaded
    if (typeof createApp === 'undefined') {
      throw new Error('App Bridge createApp not found');
    }
    
    app = createApp({
      apiKey: API_KEY,
      host: host,
    });
    appReady = true;
    console.log('[SEOBoss] App Bridge initialized');
  } catch (e) {
    console.error('[SEOBoss] Failed to initialize App Bridge:', e);
    document.getElementById('statusText').textContent = 'Failed to initialize';
    return;
  }
  // Check if we have a valid session
  (async function checkAuth() {
    try {
      const sessionToken = await app.getSessionToken();
      if (!sessionToken) {
        throw new Error('No session token');
      }
      console.log('[SEOBoss] Session token obtained');
      document.getElementById('statusText').textContent = 'Ready to activate';
      initPage();
    } catch (e) {
      console.warn('[SEOBoss] No valid session, redirecting to OAuth...', e);
      document.getElementById('statusText').textContent = 'Redirecting to authentication...';
      // Redirect to OAuth flow
      window.location.href = `/shopify-auth?shop=${encodeURIComponent(shop)}`;
    }
  })();

  // ============================================
  // 2. DOM REFERENCES
  // ============================================
  const $ = (id) => document.getElementById(id);
  const el = {
    shopInput: $('shopInput'),
    contactEmail: $('contactEmail'),
    defaultLanguage: $('defaultLanguage'),
    tone: $('tone'),
    niche: $('niche'),
    seedKeywords: $('seedKeywords'),
    targetAudience: $('targetAudience'),
    blogSelect: $('blogSelect'),
    blogRow: $('blogRow'),
    activateBtn: $('activateBtn'),
    result: $('result'),
    savedBadge: $('savedBadge'),
    savedSummary: $('savedSummary'),
    engineCard: $('engineCard'),
    openSheetBtn: $('openSheetBtn'),
    interlinkingCard: $('interlinkingCard'),
    importArticlesBtn: $('importArticlesBtn'),
    importMsg: $('importMsg'),
    clientIdDisplay: $('clientIdDisplay'),
    clientIdBadge: $('clientIdBadge'),
    clientIdHidden: $('clientIdHidden'),
    activationTokenHidden: $('activationTokenHidden'),
    statusText: $('statusText')
  };

  const statusDot = document.querySelector('.dot');

  // ============================================
  // 3. LOCAL STORAGE
  // ============================================
  const STORE_KEY = 'seoboss_client';
  const store = {
    read: () => {
      try {
        const raw = localStorage.getItem(STORE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    },
    save: (obj) => {
      try {
        localStorage.setItem(STORE_KEY, JSON.stringify(obj));
      } catch (e) {
        console.error('[SEOBoss] Failed to save to localStorage:', e);
      }
    }
  };

  // ============================================
  // 4. HELPERS
  // ============================================
  function setBusy(btn, busy, text) {
    if (!btn) return;
    btn.disabled = busy;
    if (text) btn.textContent = text;
  }

  function paintClientId(id) {
    if (!id) return;
    el.clientIdDisplay.textContent = id;
    el.clientIdBadge.style.display = 'block';
    el.clientIdHidden.value = id;
  }

  async function readJSON(response) {
    const text = await response.text();
    try {
      return JSON.parse(text);
    } catch {
      return { ok: false, raw: text };
    }
  }

  // ============================================
  // 5. PAGE INITIALIZATION
  // ============================================
  function initPage() {
    console.log('[SEOBoss] Initializing page...');
    
    // Prefill shop (disabled)
    el.shopInput.value = shop;
    
    // Store activation data from URL
    if (clientIdFromUrl) {
      el.clientIdHidden.value = clientIdFromUrl;
      paintClientId(clientIdFromUrl);
    }
    if (activationTokenFromUrl) {
      el.activationTokenHidden.value = activationTokenFromUrl;
      console.log('[SEOBoss] Activation token present');
    }
    
    // Check for existing client in localStorage
    const existingClient = store.read();
    if (existingClient && existingClient.id) {
      console.log('[SEOBoss] Found existing client:', existingClient.id);
      paintClientId(existingClient.id);
      
      // Prefill form
      if (existingClient.language) el.defaultLanguage.value = existingClient.language;
      if (existingClient.tone) el.tone.value = existingClient.tone;
      if (existingClient.niche) el.niche.value = existingClient.niche;
      if (existingClient.seed_keywords) el.seedKeywords.value = existingClient.seed_keywords;
      if (existingClient.target_audience) el.targetAudience.value = existingClient.target_audience;
      
      // Show workspace if available
      if (existingClient.sheet_url) {
        el.openSheetBtn.href = existingClient.sheet_url;
        el.engineCard.style.display = 'block';
      }
      
      // Already activated?
      if (existingClient.status === 'active') {
        el.savedBadge.style.display = 'flex';
        el.savedSummary.textContent = `${existingClient.id} · ${existingClient.shop_url || shop}`;
        el.statusText.textContent = 'Already activated';
        statusDot.style.background = 'var(--mint)';
        el.interlinkingCard.style.display = 'block';
      }
    }
  }

  // ============================================
  // 6. FORM SUBMISSION (ACTIVATION)
  // ============================================
  $('bossForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const contactEmail = (el.contactEmail.value || '').trim();
    const defaultLanguage = (el.defaultLanguage.value || 'en').trim().toLowerCase();
    const tone = (el.tone.value || '').trim();
    const niche = (el.niche.value || '').trim();
    const seedKeywords = (el.seedKeywords.value || '').trim();
    const targetAudience = (el.targetAudience.value || '').trim();
    const activationToken = el.activationTokenHidden.value || '';
    const clientId = el.clientIdHidden.value || '';
    
    // Validation
    if (!contactEmail) {
      el.result.style.display = 'block';
      el.result.innerHTML = '<span style="color:#ff9b9b">Please enter your contact email</span>';
      return;
    }
    
    if (!activationToken) {
      el.result.style.display = 'block';
      el.result.innerHTML = '<span style="color:#ff9b9b">Missing activation token. Please reinstall the app.</span>';
      return;
    }
    
    // Prepare activation payload
    const payload = {
      activation_token: activationToken,
      shop: shop,
      contact_email: contactEmail,
      default_language: defaultLanguage,
      tone: tone,
      niche: niche,
      seed_keywords: seedKeywords,
      target_audience: targetAudience
    };
    
    console.log('[SEOBoss] Activating with payload:', payload);
    
    setBusy(el.activateBtn, true, 'Activating...');
    el.result.style.display = 'block';
    el.result.textContent = 'Creating your workspace and setting up your engine...';
    
    try {
      // Get fresh session token from App Bridge
      const sessionToken = await app.getSessionToken();
      
      // POST to activation endpoint via relay
      // relay.js will handle signing when it sees the Bearer token
      const response = await fetch('/seoboss/api/onboarding/activate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionToken}`,
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      const data = await readJSON(response);
      console.log('[SEOBoss] Activation response:', data);
      
      if (!response.ok || data.ok === false) {
        throw new Error(data?.message || data?.raw || response.statusText || 'Activation failed');
      }
      
      // Success! Save profile
      const profile = {
        id: data.client_id || clientId,
        shop_url: data.shop_url || shop,
        language: defaultLanguage,
        tone, niche, 
        seed_keywords: seedKeywords, 
        target_audience: targetAudience,
        status: data.status || 'active',
        sheet_url: data.sheet_url || ''
      };
      
      store.save(profile);
      paintClientId(profile.id);
      
      // Update UI
      el.savedBadge.style.display = 'flex';
      el.savedSummary.textContent = `${profile.id} · ${profile.shop_url}`;
      statusDot.style.background = 'var(--mint)';
      el.statusText.textContent = 'Activated!';
      
      el.result.innerHTML = `
        <strong>🎉 SEOBoss is now activated!</strong><br>
        Client ID: <code>${profile.id}</code><br>
        ${data.counts?.blogs ? `Blogs connected: <code>${data.counts.blogs}</code><br>` : ''}
        ${data.message ? `<small>${data.message}</small>` : ''}
      `;
      
      // Show workspace link
      if (data.sheet_url) {
        el.openSheetBtn.href = data.sheet_url;
        el.engineCard.style.display = 'block';
      }
      
      // Show import card
      el.interlinkingCard.style.display = 'block';
      
    } catch (err) {
      console.error('[SEOBoss] Activation error:', err);
      el.result.innerHTML = `<span style="color:#ff9b9b">❌ ${err.message || 'Activation failed'}</span>`;
      statusDot.style.background = '#ff8b8b';
      statusDot.style.boxShadow = '0 0 10px rgba(255,100,100,0.9)';
    } finally {
      setBusy(el.activateBtn, false, '✨ Activate SEOBoss');
    }
  });

  // ============================================
  // 7. IMPORT ARTICLES BUTTON
  // ============================================
  el.importArticlesBtn?.addEventListener('click', async () => {
    const client = store.read();
    if (!client || !client.id) {
      el.importMsg.textContent = 'Please activate SEOBoss first';
      el.importMsg.style.color = '#ff9b9b';
      return;
    }
    
    console.log('[SEOBoss] Starting import for client:', client.id);
    setBusy(el.importArticlesBtn, true, 'Fetching...');
    el.importMsg.textContent = 'Importing your blog posts...';
    el.importMsg.style.color = '';
    
    try {
      const sessionToken = await app.getSessionToken();
      
      const response = await fetch('/seoboss/api/shop/import-articles', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionToken}`,
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          client_id: client.id,
          shop: shop
        })
      });
      
      const data = await readJSON(response);
      
      if (!response.ok || data.ok === false) {
        throw new Error(data?.message || 'Import failed');
      }
      
      el.importMsg.textContent = `✅ ${data.count || 0} posts imported successfully`;
      el.importMsg.style.color = 'var(--mint)';
      
    } catch (err) {
      console.error('[SEOBoss] Import error:', err);
      el.importMsg.textContent = '❌ ' + (err.message || 'Import failed');
      el.importMsg.style.color = '#ff9b9b';
    } finally {
      setBusy(el.importArticlesBtn, false, 'Fetch existing posts');
    }
  });

  console.log('[SEOBoss] Script initialized');
  
})();
</script>

</body>
</html>
