<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SEOBoss Onboarding</title>

  <!-- App Bridge (optional but recommended for embedded Admin) -->
  <script type="module">
    // Resolve config values from (1) hardcoded, (2) window vars, (3) query params
    const qs = new URLSearchParams(location.search);
    const HARD_API_KEY = '5654f5c575452aefdca2592d2a2d1f3d';        // <<< PUT YOUR VALUES HERE
    const HARD_HMAC    = 'SEOBOSSSECRET_2025';     // <<< PUT YOUR VALUES HERE

    const apiKey =
      HARD_API_KEY !== 'REPLACE_WITH_YOUR_APP_API_KEY' ? HARD_API_KEY :
      (window.__SEOBOSS_APP_API_KEY || qs.get('apiKey') || '');

    const publicHmacKey =
      HARD_HMAC !== 'REPLACE_WITH_PUBLIC_HMAC_KEY_2025' ? HARD_HMAC :
      (window.__SEOBOSS_PUBLIC_HMAC_KEY || qs.get('hmacKey') || '');

    // Expose for the main script
    window.__SEOBOSS_BOOT = { apiKey, publicHmacKey };

    // If we have a host param, we‚Äôre inside Admin. Load App Bridge helpers.
    if (qs.get('host')) {
      const appBridge = await import('https://unpkg.com/@shopify/app-bridge@3/dist/shopify_app_bridge.es.js');
      const utils     = await import('https://unpkg.com/@shopify/app-bridge-utils@3/dist/shopify_app_bridge_utils.es.js');

      const app = appBridge.createApp({
        apiKey: apiKey || 'missing_api_key',
        host: qs.get('host'),
        forceRedirect: true
      });

      // Expose getSessionToken for backend calls if you need it later
      window.__SEOBOSS_getSessionToken = () => utils.getSessionToken(app);
    }
  </script>

  <style>
    /* Minimal styles; keep your existing look & feel */
    body{ background:#0f1421; color:#e8fff6; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin:0 }
    .wrap{ max-width:980px; margin:0 auto; padding:16px }
    .panel{ margin:20px auto; padding:18px; border-radius:16px; background:linear-gradient(135deg,#0b0f14,#162034); box-shadow:0 0 36px rgba(0,255,200,.18) }
    .head h2{ margin:.2rem 0 .3rem; color:#42ffd2; text-shadow:0 0 10px rgba(0,255,200,.45) }
    label{ font-weight:800; color:#eafff7 } small{ color:#9fffe7 }
    input,select,textarea{ width:100%; padding:0.9rem 1rem; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); color:#fff; box-sizing:border-box }
    textarea{ min-height:50px; resize:vertical }
    .row{ display:flex; flex-direction:column; gap:.6rem; background:rgba(255,255,255,.06); padding:1rem; border:1px solid rgba(255,255,255,.09); border-radius:12px; margin:.8rem 0 }
    .row.two{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
    .actions{ display:flex; gap:.6rem; margin-top:.4rem; flex-wrap:wrap }
    .btn{ padding:.9rem 1.1rem; border-radius:12px; font-weight:900; cursor:pointer; border:1px solid rgba(255,255,255,.14); color:#eafff7; background:rgba(255,255,255,.06); text-decoration:none; display:inline-block }
    .btn.primary{ background:linear-gradient(90deg,#42ffd2,#6aa8ff); color:#062621; border:none; box-shadow:0 0 16px rgba(0,255,200,.28) }
    .btn.outline{ background:transparent; border:1px solid #42ffd2 }
    .card{ margin:1rem 0; padding:1rem; border-radius:12px; background:rgba(255,255,255,.08); color:#e9fbff; box-shadow:0 0 20px rgba(0,255,200,.20) }
    .saved{ display:flex; flex-direction:column; align-items:flex-start; gap:.6rem; color:#b9ffe9 }
    code{ background:rgba(255,255,255,.08); padding:.2rem .4rem; border-radius:6px; border:1px solid rgba(255,255,255,.14) }
    .status{ font-weight:700; margin-bottom:.4rem }
    .dot{ width:12px; height:12px; border-radius:50%; background:#42ffd2; display:inline-block; margin-right:8px; box-shadow:0 0 12px rgba(0,255,200,.6) }
    #importPreview details { margin-top:.4rem }
    #importPreview ul { margin:.4rem 0; padding-left:1.1rem }
    @media (max-width:820px){ .row.two{ grid-template-columns:1fr } .wrap{ padding:1rem } }
  </style>
</head>
<body>

  <!-- Onboarding root: update only the data-* URLs if your paths differ -->
  <div id="seoboss-onboarding"
       data-onboard-submit="https://hooks.seoboss.com/seoboss/api/onboarding/submit"
       data-onboard-activate="https://seoboss.com/pages/connect"
       data-onboard-resend="https://hooks.seoboss.com/seoboss/api/onboarding/resend"
       data-update-profile="https://hooks.seoboss.com/seoboss/api/client/profile"
       data-engine-install="https://hooks.seoboss.com/seoboss/api/engine/install"
       data-dev-mode="0">

    <div class="wrap">
      <div class="panel">
        <div class="head">
          <div class="status"><span class="dot"></span> Ready to connect</div>
          <small id="clientIdBadge" style="display:none;color:#a0ffd7">
            Client: <code id="clientIdDisplay">‚Äî</code>
          </small>
          <h2>üëë SEOBoss ‚Äî Connect Your Store</h2>
          <p class="sub">We‚Äôll discover your blogs and set up your workspace. Your Admin token is used <em>only</em> during onboarding.</p>
        </div>

        <div id="onboardWrap">
          <form id="bossForm" novalidate>
            <input id="clientIdHidden" type="hidden" value="">

            <div class="row two">
              <div>
                <label>Shopify Store (domain only)</label>
                <input id="shopInput" placeholder="yourstore.myshopify.com" required>
                <small>No https:// ‚Äî just the myshopify.com domain.</small>
              </div>
              <div id="tokenRow">
                <label>Admin API Access Token</label>
                <input id="adminToken" placeholder="shpat_‚Ä¶" required>
                <small>Not stored in the browser. Your backend will vault it securely.</small>
              </div>
            </div>

            <div class="row two">
              <div>
                <label>Language</label>
                <input id="defaultLanguage" placeholder="en" value="en" required>
              </div>
              <div>
                <label>Contact Email</label>
                <input id="contactEmail" type="email" placeholder="owner@example.com" required>
              </div>
            </div>

            <div class="row two">
              <div>
                <label>Tone</label>
                <input id="toneInput" placeholder="Helpful, expert, no hype">
              </div>
              <div>
                <label>Niche</label>
                <input id="nicheInput" placeholder="(e.g.) vocal health; natural energy drinks">
              </div>
            </div>

            <div class="row two">
              <div>
                <label>Seed keywords (comma-separated)</label>
                <textarea id="seedKeywords" rows="3" placeholder="natural energy drink, manuka honey beverage, hydration energy"></textarea>
              </div>
              <div>
                <label>Target audience</label>
                <textarea id="targetAudience" rows="3" placeholder="Adults 45+; singers; wellness shoppers"></textarea>
              </div>
            </div>

            <div id="blogRow" class="row" style="display:none">
              <div>
                <label>Default blog</label>
                <select id="blogSelect"></select>
              </div>
            </div>

            <div class="actions">
              <button id="onboardBtn" type="submit" class="btn primary big">üîå Connect</button>
            </div>

            <div id="result" class="card" style="display:none" aria-live="polite"></div>
          </form>

          <div id="savedBadge" class="saved" style="display:none">
            <span>‚úÖ Preferences saved</span>
            <code id="savedSummary"></code>
          </div>

          <div id="interlinkingCard" class="card" style="display:none">
            <div style="font-weight:800; margin-bottom:.4rem;">Interlinking: fetch your existing posts</div>
            <p style="margin:.2rem 0 .8rem">
              Import your current blog posts into your workspace. We‚Äôll keep them updated, so your internal links and topic clusters stay fresh.
            </p>
            <div class="actions">
              <button id="importArticlesBtn" class="btn outline">Fetch existing posts</button>
            </div>
            <small id="importMsg" class="msg"></small>
            <div id="importPreview" style="margin-top:.6rem"></div>
          </div>

          <div id="engineCard" class="card" style="display:none">
            <div style="font-weight:800; margin-bottom:.4rem;">Try your content engine</div>
            <p style="margin:.2rem 0 .8rem">
              Open your workspace to generate briefs, outlines, and internal links from your seed keywords.
            </p>
            <div class="actions">
              <a id="openSheetBtn" href="#" target="_blank" rel="noopener" class="btn primary">üîó Open your workspace</a>
            </div>
            <small id="engineMsg" class="msg"></small>
          </div>

          <div id="installCard" class="card" style="display:none">
            <div style="font-weight:800; margin-bottom:.4rem;">Install your engine on your store</div>
            <p style="margin:.2rem 0 .8rem">
              Add the console to your theme (automatic), or copy a snippet to embed on any page. It‚Äôs linked to your client ID.
            </p>
            <div class="actions">
              <button id="installThemeBtn" class="btn primary">‚öôÔ∏è Add to Theme (auto)</button>
              <button id="copySnippetBtn" class="btn">üìã Copy embed snippet</button>
              <a id="openConsoleBtn" class="btn outline" target="_blank" rel="noopener">üîé Open console page</a>
            </div>
            <details id="snippetBox" style="margin-top:.6rem">
              <summary>Show embed snippet</summary>
              <textarea id="embedSnippet" rows="6" readonly style="width:100%; margin-top:.4rem"></textarea>
              <small>Paste into a Liquid section or page. It will use your app proxy and your client ID.</small>
            </details>
            <small id="installMsg" class="msg"></small>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const rootEl = document.getElementById('seoboss-onboarding');

    // === Config from boot ===
    const BOOT = window.__SEOBOSS_BOOT || {};
    const SHARED_SECRET = BOOT.publicHmacKey || 'REPLACE_WITH_PUBLIC_HMAC_KEY_2025'; // fallback if not injected
    const KEY_ID = 'global';
    const DEV = (rootEl.dataset.devMode || '0') === '1' || new URLSearchParams(location.search).has('dev');
    const AUTO_DISCOVER_BLOGS = true;

    // ===== Helpers =====
    const $ = (s) => rootEl.querySelector(s);
    const result = $('#result');
    const savedBadge = $('#savedBadge');
    const savedSummary = $('#savedSummary');
    const statusDot = rootEl.querySelector('.dot');
    const clientIdBadge = $('#clientIdBadge');
    const clientIdDisplay = $('#clientIdDisplay');
    const clientIdHidden = $('#clientIdHidden');
    const interlinking = $('#interlinkingCard');
    const importBtn = $('#importArticlesBtn');
    const importMsg = $('#importMsg');
    const importPreview = $('#importPreview');
    const engineCard = $('#engineCard');
    const openSheetBtn = $('#openSheetBtn');
    const installCard = $('#installCard');
    const installBtn = $('#installThemeBtn');
    const copySnippetBtn = $('#copySnippetBtn');
    const snippetArea = $('#embedSnippet');
    const openConsoleBtn = $('#openConsoleBtn');
    const installMsg = $('#installMsg');

    const el = {
      shopInput: $('#shopInput'),
      adminToken: $('#adminToken'),
      defaultLanguage: $('#defaultLanguage'),
      contactEmail: $('#contactEmail'),
      tone: $('#toneInput'),
      niche: $('#nicheInput'),
      seedKeywords: $('#seedKeywords'),
      targetAudience: $('#targetAudience'),
      blogRow: $('#blogRow'),
      blogSelect: $('#blogSelect'),
      onboardBtn: $('#onboardBtn'),
    };

    function setBusy(btn, busy, text){
      if(!btn) return;
      if(busy){ btn.dataset.idle = btn.textContent; btn.disabled = true; btn.textContent = text || 'Working‚Ä¶'; }
      else { btn.disabled = false; btn.textContent = btn.dataset.idle || btn.textContent; }
    }
    const readJSON = async (r)=>{ const t = await r.text(); try { return t ? JSON.parse(t) : {}; } catch { return { raw: t }; } };

    function canonicalForm(obj){
      const entries = Object.entries(obj || {})
        .filter(([_,v]) => v !== undefined && v !== null && String(v).trim() !== '')
        .map(([k,v]) => [String(k), String(v)]);
      entries.sort((a,b) => a[0].localeCompare(b[0]));
      return entries.map(([k,v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v)).join('&');
    }
    async function hmacHex(secret, message){
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
      const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
      return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function signedPost(url, params, extraHeaders={}){
      const body = canonicalForm(params);
      const ts = Math.floor(Date.now()/1000).toString();
      const h  = await hmacHex(SHARED_SECRET, body + '\n' + ts);
      if (DEV) console.log('[SEOBoss signedPost]', url, params);
      return fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
          'X-Seoboss-Ts':  ts,
          'X-Seoboss-Hmac': h,
          'X-Seoboss-Key-Id': KEY_ID,
          ...extraHeaders
        },
        body
      });
    }
    function maybe(v){ v = (v ?? '').toString().trim(); return v ? v : undefined; }

    // local cache
    const store = {
      save(c){ try{ localStorage.setItem('seoboss:client', JSON.stringify(c)); }catch{} },
      read(){ try{ return JSON.parse(localStorage.getItem('seoboss:client')||'{}'); }catch{ return {}; } }
    };
    function paintClientId(id){ if(!id) return; clientIdHidden.value=id; clientIdDisplay.textContent=id; clientIdBadge.style.display=''; }

    // ===== Endpoints bridge =====
    (function initBridge(root, el){
      const ds = el?.dataset || {};
      const req = (k)=> (ds[k] && ds[k].trim()) || '';
      const endpoints = {
        onboardSubmit:   req('onboardSubmit'),
        updateProfile:   req('updateProfile'),
        engineInstall:   req('engineInstall'),
      };
      const base = endpoints.onboardSubmit ? endpoints.onboardSubmit.replace(/\/api\/onboarding\/submit.*$/,'') : '';

      root.SEO_BOSS = root.SEO_BOSS || {};
      root.SEO_BOSS.onboardSubmit  = ()=> endpoints.onboardSubmit;
      root.SEO_BOSS.updateProfile  = ()=> endpoints.updateProfile;
      root.SEO_BOSS.engineInstall  = ()=> endpoints.engineInstall;
      root.SEO_BOSS.fetchBlogs     = ()=> 'https://hooks.seoboss.com/.netlify/functions/list-blogs';
      root.SEO_BOSS.importArticles = ()=> base ? (base + '/api/shop/import-articles') : '';
    })(window, rootEl);

    // ===== Install detect & prefill =====
    let INSTALLED_MODE = false;
    let SHOP_FROM_URL = '';
    (()=>{
      const qs = new URLSearchParams(location.search);
      SHOP_FROM_URL = (qs.get('shop') || qs.get('shopify') || qs.get('shopify_domain') || '').toLowerCase();
      INSTALLED_MODE = qs.get('installed') === '1';

      const CID_FROM_URL = (qs.get('client_id') || '').trim();
      if (CID_FROM_URL) { store.save({ ...(store.read()||{}), id: CID_FROM_URL, shop_url: SHOP_FROM_URL || (store.read().shop_url||'') }); paintClientId(CID_FROM_URL); }
      else { const cached = store.read(); if (cached.id) paintClientId(cached.id); }

      if (INSTALLED_MODE) {
        el.adminToken.required = false;
        $('#tokenRow').style.display = 'none';
        el.onboardBtn.textContent = 'Save Preferences';
        $('.head .sub').textContent = 'Connected via the Shopify app ‚Äî no admin token needed.';
        if (!SHOP_FROM_URL) {
          const cachedShop = (store.read()?.shop_url || '').toLowerCase();
          if (cachedShop) SHOP_FROM_URL = cachedShop;
        }
        if (SHOP_FROM_URL) { el.shopInput.value = SHOP_FROM_URL; el.shopInput.disabled = true; }
        if (AUTO_DISCOVER_BLOGS && SHOP_FROM_URL) autoFetchBlogs();
        interlinking.style.display = '';
        showInstallCardIfReady();
      }
    })();

    // ===== Blog loader (GET only) =====
    async function autoFetchBlogs(){
      const url = window.SEO_BOSS.fetchBlogs();
      const shop = (SHOP_FROM_URL || store.read()?.shop_url || '').trim();
      if (!url || !shop) return;
      try{
        const rsp = await fetch(`${url}?shop=${encodeURIComponent(shop)}`);
        const d = await rsp.json();
        if (rsp.ok && d.ok && Array.isArray(d.blogs)) {
          const sel = el.blogSelect; sel.innerHTML = '';
          d.blogs.forEach(b=>{
            const opt = document.createElement('option');
            opt.value = String(b.id);
            opt.textContent = b.title || b.handle || ('Blog ' + b.id);
            sel.appendChild(opt);
          });
          if (d.default_blog_id) sel.value = String(d.default_blog_id);
          el.blogRow.style.display = '';
          if (d.client_id) { store.save({ ...(store.read()||{}), id: d.client_id, shop_url: shop }); paintClientId(d.client_id); }
        }
      }catch{/* silent */}
    }

    // ===== Import existing posts =====
    importBtn?.addEventListener('click', async ()=>{
      const url = window.SEO_BOSS.importArticles();
      const client = store.read() || {};
      if(!url){ importMsg.textContent = 'Import endpoint not set.'; return; }
      if(!client.id){ importMsg.textContent = 'Connect first.'; return; }

      importMsg.textContent = 'Starting import‚Ä¶';
      importPreview.innerHTML = '';
      setBusy(importBtn, true, 'Importing‚Ä¶');
      try{
        const r = await signedPost(url, { client_id: client.id });
        const d = await readJSON(r);
        if(!r.ok || d.ok === false) throw new Error(d?.message || d?.raw || ('HTTP '+r.status));

        const sample = Array.isArray(d.sample) ? d.sample.slice(0,10) : [];
        const parts = [
          `Imported ${d.imported ?? '‚Äî'} posts`,
          d.deduped ? `(deduped ${d.deduped})` : '',
          d.sheet_url ? ` ¬∑ <a href="${d.sheet_url}" target="_blank" rel="noopener">Open sheet</a>` : ''
        ].filter(Boolean).join(' ');
        importMsg.innerHTML = parts;

        if (sample.length) {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = `Preview ${sample.length} recent posts`;
          details.appendChild(summary);

          const ul = document.createElement('ul');
          sample.forEach(p=>{
            const li = document.createElement('li');
            const when = p.updated_at ? new Date(p.updated_at).toLocaleString() : '';
            li.innerHTML = `<a href="${p.url}" target="_blank" rel="noopener">${p.title || p.url}</a> <small style="opacity:.7">‚Äî ${when}</small>`;
            ul.appendChild(li);
          });
          details.appendChild(ul);
          importPreview.appendChild(details);
        }

        if (d.sheet_url) {
          openSheetBtn.href = d.sheet_url;
          engineCard.style.display = '';
        }

        showInstallCardIfReady();

      }catch(err){
        importMsg.textContent = 'Could not start import: ' + (err.message || 'Unknown');
      }finally{
        setBusy(importBtn, false);
      }
    });

    // ===== Install card =====
    function showInstallCardIfReady(){
      const client = store.read() || {};
      const shop = (client.shop_url || '').toLowerCase();
      if (!client.id || !shop) return;

      const proxyUrl = `https://${shop}/apps/seoboss/console?client_id=${encodeURIComponent(client.id)}`;
      if (openConsoleBtn) openConsoleBtn.href = proxyUrl;

      const embed = [
        `<div id="seoboss-console"`,
        `     data-client-id="${client.id}"`,
        `     data-shop="${shop}"></div>`,
        `<script async src="https://seoboss.com/engine/widget.js"><\/script>`
      ].join('\n');
      if (snippetArea) snippetArea.value = embed;

      installCard.style.display = '';
    }

    installBtn?.addEventListener('click', async ()=>{
      const url = window.SEO_BOSS.engineInstall();
      const client = store.read() || {};
      if (!url) { installMsg.textContent = 'Install endpoint not set.'; return; }
      if (!client.id || !client.shop_url) { installMsg.textContent = 'Connect first.'; return; }

      setBusy(installBtn, true, 'Installing‚Ä¶'); installMsg.textContent = '';
      try{
        const r = await signedPost(url, { client_id: client.id, shop: client.shop_url });
        const d = await readJSON(r);
        if (!r.ok || d.ok === false) throw new Error(d?.message || d?.raw || ('HTTP '+r.status));
        const pageUrl = d.page_url || openConsoleBtn?.href || `https://${client.shop_url}/pages/seoboss-console`;
        installMsg.innerHTML = `Installed. <a href="${pageUrl}" target="_blank" rel="noopener">Open page</a>`;
        if (openConsoleBtn) openConsoleBtn.href = pageUrl;
      }catch(err){
        installMsg.textContent = err.message || 'Install failed';
      }finally{
        setBusy(installBtn, false); installBtn.textContent = '‚öôÔ∏è Add to Theme (auto)';
      }
    });

    copySnippetBtn?.addEventListener('click', ()=>{
      if (!snippetArea) return;
      snippetArea.select(); document.execCommand('copy');
      copySnippetBtn.textContent = 'Copied!';
      setTimeout(()=> copySnippetBtn.textContent = 'üìã Copy embed snippet', 1200);
    });

    // ===== Form submit =====
    $('#bossForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const submitURL = window.SEO_BOSS.onboardSubmit();
      const updateURL = window.SEO_BOSS.updateProfile();

      const contact_email    = (el.contactEmail.value||'').trim();
      const default_language = (el.defaultLanguage.value||'en').trim().toLowerCase();
      const shop_input       = (el.shopInput.value||'').trim().toLowerCase();
      const admin_token      = (el.adminToken.value||'').trim();
      const tone             = (el.tone.value||'').trim();
      const niche            = (el.niche.value||'').trim();
      const seed_keywords    = (el.seedKeywords.value||'').trim();
      const target_audience  = (el.targetAudience.value||'').trim();
      const default_blog_id  = (el.blogSelect?.value || '').trim();

      if(!shop_input || !contact_email){
        result.style.display='block'; result.innerHTML = '<span style="color:#ff9b9b">Please complete required fields.</span>'; return;
      }

      const installed = location.search.includes('installed=1');

      if (installed) {
        if(!updateURL){ result.style.display='block'; result.innerHTML = '<span style="color:#ff9b9b">Profile endpoint not set.</span>'; return; }
        const client = store.read() || {};
        if (client.id) paintClientId(client.id);

        const patch = {
          client_id: client.id || clientIdHidden.value || '',
          shop: client.shop_url || shop_input,
          contact_email:    maybe(contact_email),
          default_language: maybe(default_language),
          tone:             maybe(tone),
          niche:            maybe(niche),
          seed_keywords:    maybe(seed_keywords),
          target_audience:  maybe(target_audience),
          ...(default_blog_id ? { default_blog_id } : {}),
          idem: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()))
        };

        setBusy(el.onboardBtn,true,'Saving‚Ä¶');
        result.style.display='block'; result.textContent = 'Saving your preferences‚Ä¶';

        try{
          const r = await signedPost(updateURL, patch);
          const data = await readJSON(r);
          if(!r.ok || data.ok === false) throw new Error(data?.message || data?.raw || r.statusText || 'Save failed');

          const updated = { ...client,
            id: client.id || data.client_id || '',
            shop_url: client.shop_url || shop_input,
            language: default_language,
            ...(tone ? { tone } : {}),
            ...(niche ? { niche } : {}),
            ...(seed_keywords ? { seed_keywords } : {}),
            ...(target_audience ? { target_audience } : {}),
            ...(default_blog_id ? { default_blog_id } : {})
          };
          store.save(updated); if (updated.id) paintClientId(updated.id);

          savedBadge.style.display='flex';
          savedSummary.textContent = `${updated.id || 'cli_‚Ä¶'} ¬∑ ${updated.shop_url} ¬∑ ${updated.language}`;
          statusDot.style.background = '#42ffd2';

          if (Array.isArray(data.blogs_list) && data.blogs_list.length) {
            const sel = el.blogSelect; sel.innerHTML = '';
            data.blogs_list.forEach(b=>{
              const opt = document.createElement('option');
              opt.value = String(b.id);
              opt.textContent = b.title || b.handle || ('Blog ' + b.id);
              sel.appendChild(opt);
            });
            if (data.default_blog_id) sel.value = String(data.default_blog_id);
            el.blogRow.style.display = '';
          } else {
            autoFetchBlogs();
          }

          if (data.sheet_url) { openSheetBtn.href = data.sheet_url; engineCard.style.display = ''; }
          else if (client.sheet_url) { openSheetBtn.href = client.sheet_url; engineCard.style.display = ''; }

          showInstallCardIfReady();

          result.innerHTML = '<strong>Preferences saved.</strong>';

        }catch(err){
          result.innerHTML = `<span style="color:#ff9b9b">‚ùå ${err.message || 'Failed to save'}</span>`;
          statusDot.style.background = '#ff8b8b';
        }finally{
          setBusy(el.onboardBtn,false);
        }
        return;
      }

      // Full onboarding (non-installed path)
      if(!submitURL){ result.style.display='block'; result.innerHTML = '<span style="color:#ff9b9b">Onboarding submit endpoint not set.</span>'; return; }
      if(!admin_token){
        result.style.display='block'; result.innerHTML = '<span style="color:#ff9b9b">Admin token is required to connect.</span>'; return;
      }

      setBusy(el.onboardBtn,true,'Connecting‚Ä¶');
      result.style.display='block'; result.textContent = 'Setting up your engine‚Ä¶ this can take up to a minute.';

      try{
        const payload = {
          client_name: '',
          contact_email,
          default_language,
          shop_input,
          admin_token,
          tone, niche, seed_keywords, target_audience
        };
        const r = await signedPost(submitURL, payload);
        const data = await readJSON(r);
        if(!r.ok || data.ok === false) throw new Error(data?.message || data?.raw || r.statusText || 'Submit error');

        const profile = {
          id: data.client_id || (store.read().id || ''),
          shop_url: data.shop_url || shop_input,
          default_blog_id: data.default_blog_id || '',
          language: default_language,
          tone, niche, seed_keywords, target_audience,
          ...(data.sheet_url ? { sheet_url: data.sheet_url } : {})
        };
        store.save(profile); if (profile.id) paintClientId(profile.id);

        savedBadge.style.display='flex';
        savedSummary.textContent = `${profile.id || 'cli_‚Ä¶'} ¬∑ ${profile.shop_url} ¬∑ ${profile.language}`;
        statusDot.style.background = '#42ffd2';

        if (Array.isArray(data.blogs_list) && data.blogs_list.length) {
          const sel = el.blogSelect; sel.innerHTML = '';
          data.blogs_list.forEach(b=>{
            const opt = document.createElement('option');
            opt.value = String(b.id);
            opt.textContent = b.title || b.handle || ('Blog ' + b.id);
            sel.appendChild(opt);
          });
          if (data.default_blog_id) sel.value = String(data.default_blog_id);
          el.blogRow.style.display = '';
        } else if (profile.id || profile.shop_url) {
          autoFetchBlogs();
        }

        result.innerHTML = `
          <strong>${data.message || 'Onboarding created'}</strong><br>
          Client: <code>${profile.id || '‚Äî'}</code><br>
          Shop: <code>${profile.shop_url}</code><br>
          Status: <code>${data.status || 'awaiting_activation'}</code><br>
          Blogs saved: <code>${data.counts?.blogs ?? '‚Äî'}</code>
        `;

        if (data.sheet_url) { openSheetBtn.href = data.sheet_url; engineCard.style.display = ''; }

        showInstallCardIfReady();

      }catch(err){
        result.innerHTML = `<span style="color:#ff9b9b">‚ùå ${err.message || 'Failed to connect'}</span>`;
        statusDot.style.background = '#ff8b8b';
      }finally{
        setBusy(el.onboardBtn,false);
      }
    });
  })();
  </script>
</body>
</html>
