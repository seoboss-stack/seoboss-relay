<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SEOBoss ‚Äî Connect Your Store</title>

  <!-- Shopify App Bridge UMD -->
  <script src="https://unpkg.com/@shopify/app-bridge@3.7.10/umd/index.js"></script>
  <script src="https://unpkg.com/@shopify/app-bridge-utils@3.7.10/umd/index.js"></script>

  <style>
    html, body { margin:0; padding:0; background:#0A0F0D; color:#fff; font-family:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif; overflow-x:hidden }
    #seoboss-onboarding { --mint:#00f5d4; --blue:#00bbf9; --ink:#e0ffe9; --bgA:#0f0c29; --bgB:#302b63; --bgC:#24243e;
      background:linear-gradient(270deg,var(--bgA),var(--bgB),var(--bgC)); background-size:600% 600%; animation:soGrad 20s ease infinite; min-height:100vh; padding:1rem 0 }
    @keyframes soGrad { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .wrap{ max-width:980px; margin:0 auto; padding:1.2rem }
    .panel{ margin:1.4rem auto; padding:1.4rem; border-radius:18px; background:linear-gradient(135deg,var(--bgA),var(--bgB) 60%,var(--bgA)); box-shadow:0 0 36px rgba(0,245,212,.22) }
    .head h2{ margin:.2rem 0 .3rem; color:var(--mint); text-shadow:0 0 10px rgba(0,255,200,.6) }
    .head .sub{ color:#cfefff }
    .status{ font-weight:700; margin-bottom:.4rem }
    .dot{ width:12px; height:12px; border-radius:50%; background:var(--mint); display:inline-block; margin-right:8px; box-shadow:0 0 12px rgba(0,255,200,.8); animation:pulse 1.8s infinite }
    @keyframes pulse{0%,100%{transform:scale(.9)}50%{transform:scale(1.1)}}
    label{ font-weight:800; color:#eafff7; display:block; margin-bottom:.4rem }
    small{ color:#a0ffd7; display:block; margin-top:.3rem }
    input,select,textarea{ width:100%; padding:.9rem 1rem; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); color:#fff; box-sizing:border-box; font:inherit }
    input:disabled{ opacity:.6; cursor:not-allowed }
    textarea{ min-height:50px; resize:vertical }
    .row{ display:flex; flex-direction:column; gap:.6rem; background:rgba(255,255,255,.06); padding:1rem; border:1px solid rgba(255,255,255,.09); border-radius:12px; margin:.8rem 0 }
    .row.two{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
    .actions{ display:flex; gap:.6rem; margin-top:.4rem; flex-wrap:wrap }
    .btn{ padding:.9rem 1.1rem; border-radius:12px; font-weight:900; cursor:pointer; border:1px solid rgba(255,255,255,.14); color:#eafff7; background:rgba(255,255,255,.06); text-decoration:none; display:inline-block; transition:.2s }
    .btn:hover{ background:rgba(255,255,255,.12) }
    .btn.primary{ background:linear-gradient(90deg,var(--mint),var(--blue)); color:#062621; border:none; box-shadow:0 0 16px rgba(0,255,200,.35) }
    .btn:disabled{ opacity:.5; cursor:not-allowed }
    .btn.outline{ background:transparent; border:2px solid var(--mint) }
    .card{ margin:1rem 0; padding:1rem; border-radius:12px; background:rgba(255,255,255,.08); color:#e9fbff; box-shadow:0 0 20px rgba(0,255,200,.24) }
    .saved{ display:flex; flex-direction:column; align-items:flex-start; gap:.6rem; color:#b9ffe9 }
    code{ background:rgba(255,255,255,.08); padding:.2rem .4rem; border-radius:6px; border:1px solid rgba(255,255,255,.14); font-family:ui-monospace, SFMono-Regular, Menlo, monospace }
    .msg{ display:block; margin-top:.5rem; font-size:.9rem }
    @media (max-width:820px){ .row.two{ grid-template-columns:1fr } .wrap{ padding:1rem } }
  </style>
</head>
<body>

<div id="seoboss-onboarding">
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div class="status"><span class="dot"></span> <span id="statusText">Ready to connect</span></div>
        <small id="clientIdBadge" style="display:none;color:#a0ffd7">
          Client: <code id="clientIdDisplay">‚Äî</code>
        </small>
        <h2>üëë SEOBoss ‚Äî Connect Your Store</h2>
        <p class="sub">We‚Äôll discover your blogs and set up your workspace. The Admin token is exchanged securely during install (never exposed to the browser).</p>
      </div>

      <div id="onboardWrap">
        <form id="bossForm" novalidate>
          <input id="clientIdHidden" type="hidden" value="">

          <!-- Shop (auto) -->
          <div class="row two">
            <div>
              <label>Shopify Store</label>
              <input id="shopInput" placeholder="yourstore.myshopify.com" required disabled>
              <small>Auto-filled from your Shopify admin</small>
            </div>
          </div>

          <!-- Email & Language -->
          <div class="row two">
            <div>
              <label>Contact Email</label>
              <input id="contactEmail" type="email" placeholder="owner@example.com" required>
              <small>Where should we send important updates?</small>
            </div>
            <div>
              <label>Language</label>
              <input id="defaultLanguage" placeholder="en" value="en" required>
            </div>
          </div>

          <!-- Tone & Niche -->
          <div class="row two">
            <div>
              <label>Tone</label>
              <input id="toneInput" placeholder="Helpful, expert, no hype">
            </div>
            <div>
              <label>Niche</label>
              <input id="nicheInput" placeholder="e.g., vocal health, natural energy drinks">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Seed keywords (comma-separated)</label>
              <textarea id="seedKeywords" rows="3" placeholder="natural energy drink, manuka honey beverage"></textarea>
            </div>
            <div>
              <label>Target audience</label>
              <textarea id="targetAudience" rows="3" placeholder="Adults 45+, singers, wellness shoppers"></textarea>
            </div>
          </div>

          <!-- Default blog (populated via API) -->
          <div id="blogRow" class="row" style="display:none">
            <div>
              <label>Default blog</label>
              <select id="blogSelect"></select>
            </div>
          </div>

          <div class="actions">
            <button id="onboardBtn" type="submit" class="btn primary big">üîå Connect</button>
          </div>

          <div id="result" class="card" style="display:none" aria-live="polite"></div>
        </form>

        <!-- Saved profile -->
        <div id="savedBadge" class="saved" style="display:none">
          <span>‚úÖ Preferences saved</span>
          <code id="savedSummary"></code>
        </div>

        <!-- Interlinking import -->
        <div id="interlinkingCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">üìö Import Existing Posts</div>
          <p style="margin:.2rem 0 .8rem">Import your current blog posts into your workspace for better interlinking.</p>
          <div class="actions">
            <button id="importArticlesBtn" class="btn outline">Fetch existing posts</button>
          </div>
          <small id="importMsg" class="msg"></small>
          <div id="importPreview" style="margin-top:.6rem"></div>
        </div>

        <!-- Try the engine (workspace sheet) -->
        <div id="engineCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">üöÄ Try Your Content Engine</div>
          <p style="margin:.2rem 0 .8rem">Open your workspace to generate briefs, outlines, and internal links.</p>
          <div class="actions">
            <a id="openSheetBtn" href="#" target="_blank" rel="noopener" class="btn primary">üîó Open workspace</a>
          </div>
          <small id="engineMsg" class="msg"></small>
        </div>

        <!-- Install engine on store -->
        <div id="installCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">‚öôÔ∏è Install Engine</div>
          <p style="margin:.2rem 0 .8rem">Add the console to your theme automatically, or copy the embed snippet.</p>
          <div class="actions">
            <button id="installThemeBtn" class="btn primary">‚öôÔ∏è Add to Theme</button>
            <button id="copySnippetBtn" class="btn">üìã Copy snippet</button>
            <a id="openConsoleBtn" class="btn outline" target="_blank" rel="noopener">üîé Open console</a>
          </div>
          <details id="snippetBox" style="margin-top:.6rem">
            <summary>Show embed snippet</summary>
            <textarea id="embedSnippet" rows="6" readonly style="width:100%; margin-top:.4rem"></textarea>
            <small>Paste into a Liquid section or page.</small>
          </details>
          <small id="installMsg" class="msg"></small>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ============= 1) App Bridge =============
  const qs = new URLSearchParams(location.search);
  const hostParam = qs.get('host') || '';
  const apiKey = 'YOUR_PUBLIC_API_KEY'; // <-- set your public app key

  const AppBridge = window.appBridge;
  const AppBridgeUtils = window.appBridgeUtils;

  if (!AppBridge) console.error('[SEOBoss] App Bridge UMD not loaded');
  if (!AppBridgeUtils) console.error('[SEOBoss] App Bridge Utils UMD not loaded');

  const app = (hostParam && AppBridge) ? AppBridge.createApp({ apiKey, host: hostParam }) : null;

  async function getSessionToken() {
    if (!app || !AppBridgeUtils?.getSessionToken) throw new Error('App Bridge not ready');
    return await AppBridgeUtils.getSessionToken(app);
  }

  // Optional: ensure we‚Äôre inside Admin iframe
  try {
    const Redirect = AppBridge?.actions?.Redirect;
    if (app && Redirect && window.top === window.self) {
      Redirect.create(app).dispatch(Redirect.Action.ADMIN_PATH, '/apps/your-app-slug');
    }
  } catch {}

  // ============= 2) Authenticated fetch (backend owns secrets) =============
  async function shopifyAuthorizedFetch(path, init = {}) {
    const token = await getSessionToken();
    return fetch(path, {
      ...init,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json',
        ...(init.headers || {}),
      },
      credentials: 'include'
    });
  }

  // ============= 3) DOM refs & helpers =============
  const $ = (id)=> document.getElementById(id);
  const el = {
    shopInput: $('shopInput'),
    contactEmail: $('contactEmail'),
    defaultLanguage: $('defaultLanguage'),
    tone: $('toneInput'),
    niche: $('nicheInput'),
    seedKeywords: $('seedKeywords'),
    targetAudience: $('targetAudience'),
    blogSelect: $('blogSelect'),
    blogRow: $('blogRow'),
    onboardBtn: $('onboardBtn'),
    clientIdHidden: $('clientIdHidden'),
    clientIdBadge: $('clientIdBadge'),
    clientIdDisplay: $('clientIdDisplay'),
    statusText: $('statusText'),
    result: $('result'),
    savedBadge: $('savedBadge'),
    savedSummary: $('savedSummary'),
    interlinkingCard: $('interlinkingCard'),
    importArticlesBtn: $('importArticlesBtn'),
    importMsg: $('importMsg'),
    importPreview: $('importPreview'),
    engineCard: $('engineCard'),
    openSheetBtn: $('openSheetBtn'),
    installCard: $('installCard'),
    installThemeBtn: $('installThemeBtn'),
    copySnippetBtn: $('copySnippetBtn'),
    openConsoleBtn: $('openConsoleBtn'),
    embedSnippet: $('embedSnippet'),
    installMsg: $('installMsg')
  };
  const statusDot = document.querySelector('.dot');

  const store = {
    key: 'seoboss_client',
    read(){ try{ return JSON.parse(localStorage.getItem(this.key) || 'null'); }catch{ return null; } },
    save(d){ try{ localStorage.setItem(this.key, JSON.stringify(d)); }catch{} }
  };

  function setBusy(btn, busy, text){ if(!btn) return; btn.disabled = !!busy; if(text) btn.textContent = text; }
  function paintClientId(id){ if(!id) return; el.clientIdDisplay.textContent = id; el.clientIdBadge.style.display='block'; el.clientIdHidden.value=id; }
  function showInstallCardIfReady(){
    const client = store.read(); if(!client?.id || !client?.shop_url) return;
    el.installCard.style.display='block';
    el.embedSnippet.value =
`<div id="seoboss-console"
     data-client-id="${client.id}"
     data-shop="${client.shop_url}"></div>
<script async src="https://seoboss.com/engine/widget.js"><\/script>`;
    const consoleUrl = `https://${client.shop_url}/pages/seoboss-console`;
    el.openConsoleBtn.href = consoleUrl;
  }

  // ============= 4) Derive shop from URL or JWT =============
  (async function deriveShop(){
    const shopFromUrl = (qs.get('shop') || '').toLowerCase();
    if (shopFromUrl) { el.shopInput.value = shopFromUrl; return; }
    try {
      const jwt = await getSessionToken();
      const payload = JSON.parse(atob((jwt.split('.')[1]||'').replace(/-/g,'+').replace(/_/g,'/')));
      const dest = (payload.dest || '').replace(/^https?:\/\//,'').toLowerCase();
      if (dest) el.shopInput.value = dest;
    } catch (e){
      console.warn('[SEOBoss] Could not derive shop from JWT', e);
    }
  })();

  // ============= 5) Try to fetch existing server-side state =============
  (async function bootstrap(){
    const existing = store.read();
    if (existing?.id) {
      paintClientId(existing.id);
      el.savedBadge.style.display = 'flex';
      el.savedSummary.textContent = `${existing.id} ¬∑ ${existing.shop_url || '‚Äî'} ¬∑ ${existing.language || 'en'}`;
      statusDot.style.background = 'var(--mint)';
      el.statusText.textContent = 'Connected';
      if (existing.language) el.defaultLanguage.value = existing.language;
      if (existing.tone) el.tone.value = existing.tone;
      if (existing.niche) el.niche.value = existing.niche;
      if (existing.seed_keywords) el.seedKeywords.value = existing.seed_keywords;
      if (existing.target_audience) el.targetAudience.value = existing.target_audience;
      if (existing.sheet_url) { el.openSheetBtn.href = existing.sheet_url; el.engineCard.style.display='block'; }
      el.interlinkingCard.style.display='block';
      showInstallCardIfReady();
    }

    // Optionally fetch blogs immediately
    try {
      const r = await shopifyAuthorizedFetch('/api/shop/blogs');
      if (r.ok) {
        const d = await r.json();
        if (Array.isArray(d.blogs) && d.blogs.length){
          el.blogSelect.innerHTML = '';
          d.blogs.forEach(b=>{
            const opt=document.createElement('option');
            opt.value=String(b.id);
            opt.textContent=b.title || b.handle || ('Blog '+b.id);
            el.blogSelect.appendChild(opt);
          });
          if (d.default_blog_id) el.blogSelect.value = String(d.default_blog_id);
          el.blogRow.style.display='block';
        }
        if (d.client_id) { paintClientId(d.client_id); store.save({ ...(store.read()||{}), id:d.client_id, shop_url:d.shop || el.shopInput.value }); }
      }
    } catch {}
  })();

  // ============= 6) Events =============
  // Copy snippet
  el.copySnippetBtn?.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(el.embedSnippet.value || ''); el.copySnippetBtn.textContent='‚úì Copied!'; }
    catch { el.embedSnippet.select(); document.execCommand('copy'); el.copySnippetBtn.textContent='‚úì Copied!'; }
    setTimeout(()=> el.copySnippetBtn.textContent='üìã Copy snippet', 1500);
  });

  // Install to theme (server-side)
  el.installThemeBtn?.addEventListener('click', async ()=>{
    const client = store.read();
    if (!client?.id || !client?.shop_url){ el.installMsg.textContent='No client data found'; return; }
    setBusy(el.installThemeBtn,true,'Installing‚Ä¶'); el.installMsg.textContent='Adding to your theme‚Ä¶';
    try{
      const resp = await shopifyAuthorizedFetch('/api/engine/install', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ client_id: client.id, shop: client.shop_url })
      });
      const data = await resp.json();
      if (!resp.ok || data.ok === false) throw new Error(data?.message || 'Install failed');
      const pageUrl = data.page_url || `https://${client.shop_url}/pages/seoboss-console`;
      el.installMsg.innerHTML = `‚úÖ Installed. <a href="${pageUrl}" target="_blank" rel="noopener">Open page</a>`;
      el.openConsoleBtn.href = pageUrl;
    }catch(e){
      el.installMsg.textContent = '‚ùå ' + (e.message || 'Install failed');
    }finally{
      setBusy(el.installThemeBtn,false,'‚öôÔ∏è Add to Theme');
    }
  });

  // Import existing posts (server-side)
  el.importArticlesBtn?.addEventListener('click', async ()=>{
    const client = store.read();
    if (!client?.id){ el.importMsg.textContent='Please connect your store first'; el.importMsg.style.color='#ff9b9b'; return; }
    setBusy(el.importArticlesBtn,true,'Fetching‚Ä¶'); el.importMsg.textContent='Importing your blog posts‚Ä¶'; el.importMsg.style.color='';
    try{
      const resp = await shopifyAuthorizedFetch('/api/shop/import-articles', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ client_id: client.id })
      });
      const d = await resp.json();
      if (!resp.ok || d.ok === false) throw new Error(d?.message || 'Import failed');
      el.importMsg.innerHTML = `‚úÖ Imported ${d.imported ?? '‚Äî'} posts ${d.deduped ? `(deduped ${d.deduped})` : ''} ${d.sheet_url ? `¬∑ <a href="${d.sheet_url}" target="_blank" rel="noopener">Open sheet</a>` : ''}`;
      if (Array.isArray(d.sample) && d.sample.length){
        const ul = document.createElement('ul');
        d.sample.slice(0,10).forEach(p=>{
          const li=document.createElement('li');
          const when=p.updated_at? new Date(p.updated_at).toLocaleString() : '';
          li.innerHTML=`<a href="${p.url}" target="_blank" rel="noopener">${p.title || p.url}</a> <small style="opacity:.7">‚Äî ${when}</small>`;
          ul.appendChild(li);
        });
        el.importPreview.innerHTML=''; el.importPreview.appendChild(ul);
      }
      if (d.sheet_url){ el.openSheetBtn.href=d.sheet_url; el.engineCard.style.display='block'; }
      showInstallCardIfReady();
    }catch(e){
      el.importMsg.textContent = '‚ùå ' + (e.message || 'Import failed');
    }finally{
      setBusy(el.importArticlesBtn,false,'Fetch existing posts');
    }
  });

  // Connect / Save preferences (server-side; onboarding already happened in OAuth callback)
  $('bossForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const shopInput = (el.shopInput.value || '').trim().toLowerCase();
    const contactEmail = (el.contactEmail.value || '').trim();
    const defaultLanguage = (el.defaultLanguage.value || 'en').trim().toLowerCase();
    const tone = (el.tone.value || '').trim();
    const niche = (el.niche.value || '').trim();
    const seedKeywords = (el.seedKeywords.value || '').trim();
    const targetAudience = (el.targetAudience.value || '').trim();
    const defaultBlogId = (el.blogSelect?.value || '').trim();

    if (!shopInput || !contactEmail){
      el.result.style.display='block';
      el.result.innerHTML='<span style="color:#ff9b9b">Please fill in required fields</span>';
      return;
    }

    const existing = store.read();
    const payload = {
      client_id: existing?.id || '',
      shop: shopInput,
      contact_email: contactEmail,
      default_language: defaultLanguage,
      tone, niche,
      seed_keywords: seedKeywords,
      target_audience: targetAudience,
      default_blog_id: defaultBlogId || undefined,
      idem: (crypto.randomUUID?.() || String(Date.now()))
    };

    setBusy(el.onboardBtn,true, existing?.id ? 'Saving‚Ä¶' : 'Connecting‚Ä¶');
    el.result.style.display='block';
    el.result.textContent = existing?.id ? 'Saving preferences‚Ä¶' : 'Setting up your workspace‚Ä¶';

    try{
      const resp = await shopifyAuthorizedFetch('/api/client/profile', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || data.ok === false) throw new Error(data?.message || 'Request failed');

      const clientId = data.client_id || existing?.id || '';
      const profile = {
        id: clientId || (shopInput ? `cli_${shopInput.split('.')[0]}` : ''),
        shop_url: data.shop || data.shop_url || shopInput,
        default_blog_id: data.default_blog_id || defaultBlogId || '',
        language: defaultLanguage,
        tone, niche, seed_keywords: seedKeywords, target_audience: targetAudience,
        ...(data.sheet_url ? { sheet_url: data.sheet_url } : {})
      };
      store.save(profile);
      if (profile.id) paintClientId(profile.id);

      el.savedBadge.style.display='flex';
      el.savedSummary.textContent = `${profile.id || 'cli_‚Ä¶'} ¬∑ ${profile.shop_url} ¬∑ ${profile.language}`;
      statusDot.style.background='var(--mint)'; el.statusText.textContent='Connected';

      if (Array.isArray(data.blogs_list) && data.blogs_list.length){
        el.blogSelect.innerHTML='';
        data.blogs_list.forEach(b=>{
          const opt=document.createElement('option');
          opt.value=String(b.id);
          opt.textContent=b.title || b.handle || ('Blog '+b.id);
          el.blogSelect.appendChild(opt);
        });
        if (data.default_blog_id) el.blogSelect.value = String(data.default_blog_id);
        el.blogRow.style.display='block';
      }

      if (data.sheet_url || profile.sheet_url){
        el.openSheetBtn.href = data.sheet_url || profile.sheet_url;
        el.engineCard.style.display='block';
      }

      el.interlinkingCard.style.display='block';
      showInstallCardIfReady();

      el.result.innerHTML = existing?.id
        ? '<strong>‚úÖ Preferences saved successfully!</strong>'
        : `<strong>${data.message || '‚úÖ Successfully connected!'}</strong><br>
           ${profile.id ? `Client ID: <code>${profile.id}</code><br>` : ''}
           Shop: <code>${profile.shop_url}</code><br>
           ${data.status ? `Status: <code>${data.status}</code><br>` : ''}`;

    }catch(e){
      el.result.innerHTML = `<span style="color:#ff9b9b">‚ùå ${e.message || 'Failed to connect'}</span>`;
      statusDot.style.background='#ff8b8b'; statusDot.style.boxShadow='0 0 10px rgba(255,100,100,.9)';
    }finally{
      setBusy(el.onboardBtn,false,'üîå Connect');
    }
  });

  console.log('[SEOBoss] Embedded page ready');
})();
</script>

</body>
</html>
