<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SEOBoss — Connect Your Store</title>

  <!-- Shopify App Bridge (Official CDN) -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #0A0F0D;
      color: #fff;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }
    
    #seoboss-onboarding {
      --mint: #00f5d4;
      --blue: #00bbf9;
      --ink: #e0ffe9;
      --bgA: #0f0c29;
      --bgB: #302b63;
      --bgC: #24243e;
      background: linear-gradient(270deg, var(--bgA), var(--bgB), var(--bgC));
      background-size: 600% 600%;
      animation: soGrad 20s ease infinite;
      min-height: 100vh;
      padding: 1rem 0;
    }
    
    @keyframes soGrad {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 1.2rem;
    }
    
    .panel {
      margin: 1.4rem auto;
      padding: 1.4rem;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--bgA), var(--bgB) 60%, var(--bgA));
      box-shadow: 0 0 36px rgba(0, 245, 212, 0.22);
    }
    
    .head h2 {
      margin: 0.2rem 0 0.3rem;
      color: var(--mint);
      text-shadow: 0 0 10px rgba(0, 255, 200, 0.6);
    }
    
    .head .sub {
      color: #cfefff;
    }
    
    .status {
      font-weight: 700;
      margin-bottom: 0.4rem;
    }
    
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--mint);
      display: inline-block;
      margin-right: 8px;
      box-shadow: 0 0 12px rgba(0, 255, 200, 0.8);
      animation: pulse 1.8s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(0.9); }
      50% { transform: scale(1.1); }
    }
    
    label {
      font-weight: 800;
      color: #eafff7;
      display: block;
      margin-bottom: 0.4rem;
    }
    
    small {
      color: #a0ffd7;
      display: block;
      margin-top: 0.3rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 1rem;
    }
    
    input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.04);
    }
    
    textarea {
      min-height: 50px;
      resize: vertical;
    }
    
    .row {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      background: rgba(255, 255, 255, 0.06);
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: 12px;
      margin: 0.8rem 0;
    }
    
    .row.two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.4rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 0.9rem 1.1rem;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.14);
      color: #eafff7;
      background: rgba(255, 255, 255, 0.06);
      text-decoration: none;
      display: inline-block;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.12);
    }
    
    .btn.primary {
      background: linear-gradient(90deg, var(--mint), var(--blue));
      color: #062621;
      border: none;
      box-shadow: 0 0 16px rgba(0, 255, 200, 0.35);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .card {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      color: #e9fbff;
      box-shadow: 0 0 20px rgba(0, 255, 200, 0.24);
    }
    
    .saved {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.6rem;
      color: #b9ffe9;
    }
    
    code {
      background: rgba(255, 255, 255, 0.08);
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-family: 'Courier New', monospace;
    }
    
    @media (max-width: 820px) {
      .row.two {
        grid-template-columns: 1fr;
      }
      .wrap {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

<div id="seoboss-onboarding">
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div class="status"><span class="dot"></span> <span id="statusText">Initializing...</span></div>
        <small id="clientIdBadge" style="display:none;color:#a0ffd7">
          Client: <code id="clientIdDisplay">—</code>
        </small>
        <h2>👑 SEOBoss — Connect Your Store</h2>
        <p class="sub">We'll discover your blogs and set up your workspace. Your Admin token is handled securely.</p>
      </div>

      <div id="onboardWrap">
        <form id="bossForm" novalidate>
          <!-- Hidden token field - populated from cookie -->
          <input id="adminTokenHidden" type="hidden" value="">

          <!-- Shop (visible but disabled) -->
          <div class="row">
            <div>
              <label>Shopify Store</label>
              <input id="shopInput" placeholder="yourstore.myshopify.com" disabled>
              <small>Your store domain (provided automatically).</small>
            </div>
          </div>

          <!-- Contact & Language -->
          <div class="row two">
            <div>
              <label>Contact Email</label>
              <input id="contactEmail" type="email" placeholder="owner@example.com" required>
            </div>
            <div>
              <label>Language</label>
              <input id="defaultLanguage" placeholder="en" value="en" required>
            </div>
          </div>

          <!-- Tone & Niche -->
          <div class="row two">
            <div>
              <label>Tone</label>
              <input id="tone" placeholder="Helpful, expert, no hype">
              <small>Your brand voice.</small>
            </div>
            <div>
              <label>Niche</label>
              <input id="niche" placeholder="e.g. vocal health, natural energy drinks">
              <small>Your business focus.</small>
            </div>
          </div>

          <!-- Keywords & Audience -->
          <div class="row two">
            <div>
              <label>Seed keywords (comma-separated)</label>
              <textarea id="seedKeywords" rows="3" placeholder="natural energy drink, manuka honey beverage, hydration energy"></textarea>
            </div>
            <div>
              <label>Target audience</label>
              <textarea id="targetAudience" rows="3" placeholder="Adults 45+; singers; wellness shoppers"></textarea>
            </div>
          </div>

          <div class="actions">
            <button id="connectBtn" type="submit" class="btn primary big">🔌 Connect</button>
          </div>

          <div id="result" class="card" style="display:none" aria-live="polite"></div>
        </form>

        <!-- Success badge -->
        <div id="savedBadge" class="saved" style="display:none">
          <span>✅ Connected!</span>
          <code id="savedSummary"></code>
        </div>

        <!-- Workspace card -->
        <div id="engineCard" class="card" style="display:none">
          <div style="font-weight:800; margin-bottom:.4rem;">🚀 Your Content Engine is Ready</div>
          <p style="margin:.2rem 0 .8rem">
            Open your workspace to generate briefs, outlines, and internal links.
          </p>
          <div class="actions">
            <a id="openSheetBtn" href="#" target="_blank" rel="noopener" class="btn primary">🔗 Open workspace</a>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ============================================
  // 1. PARSE URL & READ COOKIE
  // ============================================
  const urlParams = new URLSearchParams(window.location.search);
  const shop = urlParams.get('shop') || '';
  const host = urlParams.get('host') || '';
  
  console.log('[SEOBoss] Page loaded', { shop, host });

  if (!shop) {
    document.getElementById('statusText').textContent = 'Error: Missing shop parameter';
    console.error('[SEOBoss] No shop parameter in URL!');
    return;
  }

  // Read token from cookie
  function getCookie(name) {
    const cookies = document.cookie.split(';');
    const cookie = cookies.find(c => c.trim().startsWith(name + '='));
    return cookie ? cookie.split('=')[1].trim() : '';
  }

  const adminToken = getCookie('shop_token');
  console.log('[SEOBoss] Token from cookie:', adminToken ? 'present' : 'MISSING');

  if (!adminToken) {
    console.warn('[SEOBoss] No token in cookie - user may need to reinstall or OAuth failed');
  }

  const API_KEY = '5654f5c575452aefdca2592d2a2d1f3d';
  
  // ============================================
  // 2. SHOP-SPECIFIC LOCALSTORAGE
  // ============================================
  const shopKey = shop.replace(/[^a-z0-9]/gi, '_');
  const store = {
    key: `seoboss_client_${shopKey}`,
    read() {
      try {
        const raw = localStorage.getItem(this.key);
        const data = raw ? JSON.parse(raw) : null;
        if (data && data.shop_url && data.shop_url !== shop) {
          console.warn('[SEOBoss] Shop mismatch! Clearing', {stored: data.shop_url, current: shop});
          this.clear();
          return null;
        }
        return data;
      } catch {
        return null;
      }
    },
    save(data) {
      try {
        data.shop_url = data.shop_url || shop;
        localStorage.setItem(this.key, JSON.stringify(data));
      } catch (e) {
        console.error('[SEOBoss] localStorage save failed:', e);
      }
    },
    clear() {
      try {
        localStorage.removeItem(this.key);
      } catch {}
    }
  };
  
  // ============================================
  // 3. APP BRIDGE INITIALIZATION
  // ============================================
  let app = null;
  
  const AppBridge = window.Shopify?.AppBridge;
  if (!AppBridge || !AppBridge.createApp) {
    console.error('[SEOBoss] App Bridge not loaded!');
    console.error('[SEOBoss] window.Shopify:', window.Shopify);
    document.getElementById('statusText').textContent = 'Failed to load App Bridge';
    return;
  }
  
  try {
    app = AppBridge.createApp({
      apiKey: API_KEY,
      host: host,
    });
    console.log('[SEOBoss] App Bridge initialized');
  } catch (e) {
    console.error('[SEOBoss] App Bridge init failed:', e);
    document.getElementById('statusText').textContent = 'Failed to initialize';
    return;
  }

  // Get session token helper
  async function getSessionToken() {
    if (!app) throw new Error('App Bridge not initialized');
    
    try {
      const utils = window.Shopify?.AppBridge?.utilities;
      if (utils?.getSessionToken) {
        return await utils.getSessionToken(app);
      }
      if (app.getSessionToken) {
        return await app.getSessionToken();
      }
      throw new Error('getSessionToken not available');
    } catch (e) {
      console.error('[SEOBoss] Failed to get session token:', e);
      throw e;
    }
  }

  // Check auth on page load
  (async function checkAuth() {
    try {
      const sessionToken = await getSessionToken();
      if (!sessionToken) {
        throw new Error('No session token');
      }
      console.log('[SEOBoss] Session token obtained');
      document.getElementById('statusText').textContent = 'Ready to connect';
      initPage();
    } catch (e) {
      console.warn('[SEOBoss] No valid session, redirecting to OAuth...', e);
      document.getElementById('statusText').textContent = 'Redirecting to authentication...';
      window.location.href = `/shopify-auth?shop=${encodeURIComponent(shop)}`;
    }
  })();

  // ============================================
  // 4. DOM REFERENCES
  // ============================================
  const $ = (id) => document.getElementById(id);
  const el = {
    shopInput: $('shopInput'),
    adminTokenHidden: $('adminTokenHidden'),
    contactEmail: $('contactEmail'),
    defaultLanguage: $('defaultLanguage'),
    tone: $('tone'),
    niche: $('niche'),
    seedKeywords: $('seedKeywords'),
    targetAudience: $('targetAudience'),
    connectBtn: $('connectBtn'),
    result: $('result'),
    savedBadge: $('savedBadge'),
    savedSummary: $('savedSummary'),
    engineCard: $('engineCard'),
    openSheetBtn: $('openSheetBtn'),
    clientIdDisplay: $('clientIdDisplay'),
    clientIdBadge: $('clientIdBadge'),
    statusText: $('statusText')
  };

  const statusDot = document.querySelector('.dot');

  // ============================================
  // 5. HELPERS
  // ============================================
  function setBusy(btn, busy, text) {
    if (!btn) return;
    btn.disabled = busy;
    if (text) btn.textContent = text;
  }

  function paintClientId(id) {
    if (!id) return;
    el.clientIdDisplay.textContent = id;
    el.clientIdBadge.style.display = 'block';
  }

  async function readJSON(response) {
    const text = await response.text();
    try {
      return JSON.parse(text);
    } catch {
      return { ok: false, raw: text };
    }
  }

  // ============================================
  // 6. PAGE INITIALIZATION
  // ============================================
  function initPage() {
    console.log('[SEOBoss] Initializing page...');
    
    // Prefill shop (disabled) and token (hidden)
    el.shopInput.value = shop;
    el.adminTokenHidden.value = adminToken;
    
    // Check for existing client
    const existingClient = store.read();
    if (existingClient && existingClient.id) {
      console.log('[SEOBoss] Found existing client:', existingClient.id);
      paintClientId(existingClient.id);
      
      // Prefill form
      if (existingClient.language) el.defaultLanguage.value = existingClient.language;
      if (existingClient.tone) el.tone.value = existingClient.tone;
      if (existingClient.niche) el.niche.value = existingClient.niche;
      if (existingClient.seed_keywords) el.seedKeywords.value = existingClient.seed_keywords;
      if (existingClient.target_audience) el.targetAudience.value = existingClient.target_audience;
      
      // Show workspace if available
      if (existingClient.sheet_url) {
        el.openSheetBtn.href = existingClient.sheet_url;
        el.engineCard.style.display = 'block';
      }
      
      // Already connected?
      if (existingClient.status === 'active') {
        el.savedBadge.style.display = 'flex';
        el.savedSummary.textContent = `${existingClient.id} · ${existingClient.shop_url || shop}`;
        el.statusText.textContent = 'Already connected';
        statusDot.style.background = 'var(--mint)';
      }
    }
  }

  // ============================================
  // 7. FORM SUBMISSION - ONE STEP!
  // ============================================
  $('bossForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const contactEmail = (el.contactEmail.value || '').trim();
    const defaultLanguage = (el.defaultLanguage.value || 'en').trim().toLowerCase();
    const tone = (el.tone.value || '').trim();
    const niche = (el.niche.value || '').trim();
    const seedKeywords = (el.seedKeywords.value || '').trim();
    const targetAudience = (el.targetAudience.value || '').trim();
    const token = el.adminTokenHidden.value || '';
    
    // Validation
    if (!contactEmail) {
      el.result.style.display = 'block';
      el.result.innerHTML = '<span style="color:#ff9b9b">Please enter your contact email</span>';
      return;
    }
    
    if (!token) {
      el.result.style.display = 'block';
      el.result.innerHTML = '<span style="color:#ff9b9b">Missing admin token. Please reinstall the app.</span>';
      console.error('[SEOBoss] No admin token - cannot connect');
      return;
    }
    
    // Prepare payload - send EVERYTHING to n8n in ONE call!
    const payload = {
      client_name: '',
      contact_email: contactEmail,
      default_language: defaultLanguage,
      shop_input: shop,
      admin_token: token, // ← THE TOKEN FROM COOKIE!
      tone: tone,
      niche: niche,
      seed_keywords: seedKeywords,
      target_audience: targetAudience
    };
    
    console.log('[SEOBoss] Submitting to n8n with ALL data:', {
      ...payload,
      admin_token: token ? 'present' : 'MISSING'
    });
    
    setBusy(el.connectBtn, true, 'Connecting...');
    el.result.style.display = 'block';
    el.result.textContent = 'Setting up your workspace... this can take up to a minute.';
    
    try {
      // Get fresh session token from App Bridge
      const sessionToken = await getSessionToken();
      
      // POST to /onboarding/submit via relay - ONE CALL with EVERYTHING!
      // relay.js will detect Bearer token and handle signing server-side
      const response = await fetch('/seoboss/api/onboarding/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionToken}`,
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      console.log('[SEOBoss] Response status:', response.status);
      
      const data = await readJSON(response);
      console.log('[SEOBoss] Response data:', data);
      
      if (!response.ok || data.ok === false) {
        throw new Error(data?.message || data?.raw || response.statusText || 'Connection failed');
      }
      
      // Success! Save profile
      const profile = {
        id: data.client_id || '',
        shop_url: data.shop_url || shop,
        language: defaultLanguage,
        tone, niche, 
        seed_keywords: seedKeywords, 
        target_audience: targetAudience,
        status: data.status || 'active',
        sheet_url: data.sheet_url || ''
      };
      
      store.save(profile);
      paintClientId(profile.id);
      
      // Update UI
      el.savedBadge.style.display = 'flex';
      el.savedSummary.textContent = `${profile.id} · ${profile.shop_url}`;
      statusDot.style.background = 'var(--mint)';
      el.statusText.textContent = 'Connected!';
      
      el.result.innerHTML = `
        <strong>🎉 SEOBoss is now connected!</strong><br>
        Client ID: <code>${profile.id}</code><br>
        Shop: <code>${profile.shop_url}</code><br>
        ${data.counts?.blogs ? `Blogs: <code>${data.counts.blogs}</code><br>` : ''}
        ${data.message ? `<small>${data.message}</small>` : ''}
      `;
      
      // Show workspace link
      if (data.sheet_url) {
        el.openSheetBtn.href = data.sheet_url;
        el.engineCard.style.display = 'block';
      }
      
    } catch (err) {
      console.error('[SEOBoss] Connection error:', err);
      el.result.innerHTML = `<span style="color:#ff9b9b">❌ ${err.message || 'Connection failed'}</span>`;
      statusDot.style.background = '#ff8b8b';
      statusDot.style.boxShadow = '0 0 10px rgba(255,100,100,0.9)';
    } finally {
      setBusy(el.connectBtn, false, '🔌 Connect');
    }
  });

  console.log('[SEOBoss] Script loaded');
  
})();
</script>

</body>
</html>
